import logging
import pathlib
import sys

import paramiko
import asyncio
import os
import sqlite3
import time
import hashlib
import secrets
from contextlib import contextmanager
from dotenv import load_dotenv
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    ContextTypes,
    CallbackQueryHandler,
)

from src.commands.admin_commands.approve import approve_user_command
from src.commands.admin_commands.set_timeout import set_timeout
from src.commands.login import login
from src.commands.logout import logout
from src.commands.register import register
from src.commands.restart import restart
from src.commands.start import start
from src.config import AppConfig, config
from src.db.utils import init_db
from src.handlers.buttons.approve_button import button_approve_handler
from src.handlers.buttons.main_buttons import button_handler
from src.handlers.buttons.settings_buttons import settings_button_handler

# # --- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ---
# logging.basicConfig(
#     format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
#     level=logging.INFO
# )
# logger = logging.getLogger(__name__)
#
# if pathlib.Path.exists(pathlib.Path(".env")):
#     logger.info(".env found, loading...")
#     load_dotenv(".env")
# else:
#     logger.error("File not found, please check your env file")
#     sys.exit(1)

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
# BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')
# SSH_HOST = os.getenv('SSH_HOST')
# SSH_PORT = int(os.getenv('SSH_PORT', 22))
# # SSH —É—á—ë—Ç–∫–∞ –±–æ—Ç–∞
# BOT_SSH_USER = os.getenv('BOT_SSH_USER')
# BOT_SSH_PASS = os.getenv('BOT_SSH_PASS')
# ADMIN_TELEGRAM_ID = int(os.getenv('ADMIN_TELEGRAM_ID'))
# PASSWORD_HASH_SECRET = os.getenv('PASSWORD_HASH_SECRET')
# # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º SESSION_TIMEOUT –∏–∑ .env –∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
# SESSION_TIMEOUT = int(os.getenv('SESSION_TIMEOUT', 300)) # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 5 –º–∏–Ω—É—Ç



# --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î ---
# DB_NAME = "bot_users.db"
#
# def init_db():
#     """–°–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Å–µ—Å—Å–∏–π, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç."""
#     with get_db_connection() as conn:
#         cursor = conn.cursor()
#         # –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–æ—Ç–∞
#         cursor.execute('''
#             CREATE TABLE IF NOT EXISTS bot_users (
#                 id INTEGER PRIMARY KEY AUTOINCREMENT,
#                 telegram_id INTEGER UNIQUE NOT NULL,
#                 username TEXT UNIQUE NOT NULL, -- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ª–æ–≥–∏–Ω –≤ –±–æ—Ç–µ
#                 password_hash TEXT NOT NULL, -- –•–µ—à –ø–∞—Ä–æ–ª—è
#                 salt TEXT NOT NULL, -- –°–æ–ª—å –¥–ª—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
#                 status TEXT NOT NULL DEFAULT 'pending', -- 'pending', 'active', 'banned'
#                 registered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
#             )
#         ''')
#         # –¢–∞–±–ª–∏—Ü–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π –±–æ—Ç–∞ (–≤—Ä–µ–º–µ–Ω–Ω–æ —Ö—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
#         cursor.execute('''
#             CREATE TABLE IF NOT EXISTS active_sessions (
#                 telegram_id INTEGER PRIMARY KEY,
#                 bot_user_id INTEGER NOT NULL,
#                 timestamp REAL NOT NULL,
#                 FOREIGN KEY (bot_user_id) REFERENCES bot_users (id)
#             )
#         ''')
#         conn.commit()
#         logger.info("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞.")
#
# @contextmanager
# def get_db_connection():
#     """–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î."""
#     conn = sqlite3.connect(DB_NAME)
#     try:
#         yield conn
#     finally:
#         conn.close()
#
# # --- –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –ë–î (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏) ---
# def register_bot_user(telegram_id: int, username: str, password: str) -> bool:
#     """–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–æ—Ç–∞. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ."""
#     try:
#         salt = secrets.token_hex(16)
#         password_hash = hashlib.pbkdf2_hmac('sha256', password.encode('utf-8'), (PASSWORD_HASH_SECRET + salt).encode('utf-8'), 100000).hex()
#         with get_db_connection() as conn:
#             cursor = conn.cursor()
#             cursor.execute(
#                 "INSERT INTO bot_users (telegram_id, username, password_hash, salt, status) VALUES (?, ?, ?, ?, 'pending')",
#                 (telegram_id, username, password_hash, salt)
#             )
#             conn.commit()
#         return True
#     except sqlite3.IntegrityError as e: # –ù–∞–ø—Ä–∏–º–µ—Ä, –¥—É–±–ª–∏–∫–∞—Ç telegram_id –∏–ª–∏ username
#         logger.warning(f"–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}/{username}: {e}")
#         return False
#
# def get_user_status(telegram_id: int) -> str | None:
#     """–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ Telegram ID."""
#     with get_db_connection() as conn:
#         cursor = conn.cursor()
#         cursor.execute("SELECT status FROM bot_users WHERE telegram_id = ?", (telegram_id,))
#         row = cursor.fetchone()
#         return row[0] if row else None
#
# def approve_user(telegram_id: int):
#     """–û–¥–æ–±—Ä—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –º–µ–Ω—è—è —Å—Ç–∞—Ç—É—Å –Ω–∞ 'active'."""
#     with get_db_connection() as conn:
#         cursor = conn.cursor()
#         cursor.execute("UPDATE bot_users SET status = 'active' WHERE telegram_id = ?", (telegram_id,))
#         conn.commit()
#
# def authenticate_user(username: str, password: str) -> tuple[int | None, int | None]:
#     """
#     –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –ª–æ–≥–∏–Ω—É –∏ –ø–∞—Ä–æ–ª—é.
#     –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (telegram_id, bot_user_id) –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ, –∏–Ω–∞—á–µ (None, None).
#     """
#     with get_db_connection() as conn:
#         cursor = conn.cursor()
#         cursor.execute("SELECT id, telegram_id, password_hash, salt FROM bot_users WHERE username = ? AND status = 'active'", (username,))
#         row = cursor.fetchone()
#         if row:
#             bot_user_id, telegram_id, stored_hash, salt = row
#             password_hash = hashlib.pbkdf2_hmac('sha256', password.encode('utf-8'), (PASSWORD_HASH_SECRET + salt).encode('utf-8'), 100000).hex()
#             if secrets.compare_digest(password_hash, stored_hash): # –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
#                 return telegram_id, bot_user_id
#     return None, None
#
# def is_user_active(telegram_id: int) -> bool:
#     """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ Telegram ID."""
#     status = get_user_status(telegram_id)
#     return status == 'active'
#
# # --- –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –ë–î (–°–µ—Å—Å–∏–∏) ---
# def create_session(telegram_id: int, bot_user_id: int):
#     """–°–æ–∑–¥–∞—ë—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
#     timestamp = time.time()
#     with get_db_connection() as conn:
#         cursor = conn.cursor()
#         cursor.execute(
#             "INSERT OR REPLACE INTO active_sessions (telegram_id, bot_user_id, timestamp) VALUES (?, ?, ?)",
#             (telegram_id, bot_user_id, timestamp)
#         )
#         conn.commit()
#
# def get_session(telegram_id: int) -> tuple[int | None, float | None]:
#     """–ü–æ–ª—É—á–∞–µ—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–æ—Ç–∞ –∏ –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É —Å–µ—Å—Å–∏–∏. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (bot_user_id, timestamp) –∏–ª–∏ (None, None)."""
#     with get_db_connection() as conn:
#         cursor = conn.cursor()
#         cursor.execute("SELECT bot_user_id, timestamp FROM active_sessions WHERE telegram_id = ?", (telegram_id,))
#         row = cursor.fetchone()
#         return row if row else (None, None)
#
# def delete_session(telegram_id: int):
#     """–£–¥–∞–ª—è–µ—Ç —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
#     with get_db_connection() as conn:
#         cursor = conn.cursor()
#         cursor.execute("DELETE FROM active_sessions WHERE telegram_id = ?", (telegram_id,))
#         conn.commit()
#
# def cleanup_expired_sessions():
#     """–£–¥–∞–ª—è–µ—Ç –∏—Å—Ç—ë–∫—à–∏–µ —Å–µ—Å—Å–∏–∏ –∏–∑ –ë–î."""
#     now = time.time()
#     expired_time = now - SESSION_TIMEOUT
#     with get_db_connection() as conn:
#         cursor = conn.cursor()
#         cursor.execute("DELETE FROM active_sessions WHERE timestamp < ?", (expired_time,))
#         deleted_count = cursor.rowcount
#         conn.commit()
#         if deleted_count > 0:
#             logger.info(f"–£–¥–∞–ª–µ–Ω–æ {deleted_count} –∏—Å—Ç—ë–∫—à–∏—Ö —Å–µ—Å—Å–∏–π.")

# --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (—á–µ—Ä–µ–∑ SSH) ---
# async def restart_user_session_on_server(target_username: str) -> str:
#     """
#     –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ SSH —Å —É—á—ë—Ç–∫–æ–π –±–æ—Ç–∞ –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.
#     """
#     try:
#         ssh = paramiko.SSHClient()
#         ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
#         # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
#         ssh.connect(
#             hostname=SSH_HOST,
#             port=SSH_PORT,
#             username=BOT_SSH_USER,
#             password=BOT_SSH_PASS
#         )
#         # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É –ø–æ–∏—Å–∫–∞ —Å–µ—Å—Å–∏–∏
#         stdin, stdout, stderr = ssh.exec_command(f'query session {target_username}')
#         # –ß–∏—Ç–∞–µ–º –≤—ã–≤–æ–¥ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π –¥–ª—è Windows (cp866 –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ)
#         output = stdout.read().decode('cp866', errors='ignore').strip()
#         # print(output) # –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
#         error = stderr.read().decode('cp866', errors='ignore').strip()
#         # –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å)
#         logger.info(f"–í—ã–≤–æ–¥ query session –¥–ª—è {target_username}:\n{output}")
#         if error:
#             logger.warning(f"STDERR –¥–ª—è {target_username}:\n{error}")
#         # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫–∏
#         if error and not output:
#             ssh.close()
#             return f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Å–µ—Å—Å–∏–∏: {error}"
#         # –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
#         if ("–ù–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç —Å–µ–∞–Ω—Å—ã –¥–ª—è" in output or
#                 "–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" in output or
#                 "The session name is invalid" in output or
#                 "not found" in output.lower()):
#             ssh.close()
#             return f"‚ÑπÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å '{target_username}' –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω."
#         # –†–∞–∑–±–æ—Ä —Å—Ç—Ä–æ–∫
#         lines = output.split('\n')
#         if len(lines) < 2:
#             ssh.close()
#             return "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ —Å–µ—Å—Å–∏–∏ (–Ω–µ–ø–æ–ª–Ω—ã–π –≤—ã–≤–æ–¥)."
#         # –ë–µ—Ä—ë–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É —Å –¥–∞–Ω–Ω—ã–º–∏ –æ —Å–µ—Å—Å–∏–∏ (–æ–±—ã—á–Ω–æ –ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞)
#         session_line = ""
#         for line in lines[1:]:
#             line = line.strip()
#             if line and not line.startswith('-'):
#                 session_line = line
#                 break
#         if not session_line:
#             ssh.close()
#             return "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Å—Ç—Ä–æ–∫—É —Å –¥–∞–Ω–Ω—ã–º–∏ –æ —Å–µ—Å—Å–∏–∏."
#         # –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ –ø—Ä–æ–±–µ–ª–∞–º
#         parts = session_line.split()
#         if len(parts) < 3:
#             ssh.close()
#             return f"‚ùå –û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ —Å—Ç—Ä–æ–∫–∏ —Å–µ—Å—Å–∏–∏: '{session_line}'"
#         # ID —Å–µ—Å—Å–∏–∏ ‚Äî —Ç—Ä–µ—Ç–∏–π —ç–ª–µ–º–µ–Ω—Ç
#         session_id = parts[2]
#         # print(parts) # –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
#         # –ó–∞–≤–µ—Ä—à–∞–µ–º —Å–µ—Å—Å–∏—é
#         stdin, stdout, stderr = ssh.exec_command(f'logoff {session_id}')
#         logoff_error = stderr.read().decode('cp866', errors='ignore').strip()
#         ssh.close()
#         if logoff_error:
#             return f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏: {logoff_error}"
#         else:
#             return f"‚úÖ –°–µ—Å—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è '{target_username}' (ID: {session_id}) —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."
#     except Exception as e:
#         logger.error(f"–û—à–∏–±–∫–∞ SSH: {e}")
#         return f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)}"

# --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é ---
# def get_main_menu(is_logged_in: bool = False, is_admin: bool = False):
#     keyboard = []
#     if not is_logged_in:
#         keyboard.append([InlineKeyboardButton("üîë –í–æ–π—Ç–∏", callback_data='login')])
#         keyboard.append([InlineKeyboardButton("üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è", callback_data='register')])
#     else:
#         keyboard.append([InlineKeyboardButton("üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Å—Å–∏—é", callback_data='restart')])
#         keyboard.append([InlineKeyboardButton("üö™ –í—ã–π—Ç–∏", callback_data='logout')])
#
#     # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
#     if is_admin:
#         keyboard.append([InlineKeyboardButton("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", callback_data='settings')])
#
#     return InlineKeyboardMarkup(keyboard)

# # --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫ ---
# def get_settings_menu():
#     keyboard = [
#         [InlineKeyboardButton(f"‚è±Ô∏è –¢–∞–π–º–∞—É—Ç —Å–µ—Å—Å–∏–∏: {SESSION_TIMEOUT} —Å–µ–∫", callback_data='dummy_info')], # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞
#         [InlineKeyboardButton("‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å —Ç–∞–π–º–∞—É—Ç", callback_data='change_timeout')],
#         [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='back_to_main')],
#     ]
#     return InlineKeyboardMarkup(keyboard)

# --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è ---
# async def update_main_message(update: Update, context: ContextTypes.DEFAULT_TYPE, status_text: str, is_logged_in: bool = False):
#     """–û–±–Ω–æ–≤–ª—è–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞ —Å –Ω–æ–≤—ã–º —Å—Ç–∞—Ç—É—Å–æ–º –∏ –º–µ–Ω—é."""
#     user_id = update.effective_user.id
#     is_admin = (user_id == ADMIN_TELEGRAM_ID)
#     menu_markup = get_main_menu(is_logged_in, is_admin)
#
#     # –ü–æ–ª—É—á–∞–µ–º chat_id –∏ message_id –∏–∑ context.user_data –∏–ª–∏ update
#     chat_id = context.user_data.get('main_menu_chat_id') or update.effective_chat.id
#     message_id = context.user_data.get('main_menu_message_id')
#
#     # –ï—Å–ª–∏ message_id –∏–∑–≤–µ—Å—Ç–µ–Ω, –ø—ã—Ç–∞–µ–º—Å—è –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
#     if message_id:
#         try:
#             await context.bot.edit_message_text(
#                 chat_id=chat_id,
#                 message_id=message_id,
#                 text=status_text,
#                 reply_markup=menu_markup,
#                 parse_mode='Markdown'
#             )
#             logger.debug(f"–°–æ–æ–±—â–µ–Ω–∏–µ {message_id} –≤ —á–∞—Ç–µ {chat_id} –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ.")
#             return # –£—Å–ø–µ—à–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª–∏, –≤—ã—Ö–æ–¥–∏–º
#         except Exception as e:
#             error_message = str(e).lower()
#             if "message to edit not found" in error_message or "message_id_invalid" in error_message or "message not found" in error_message:
#                 logger.warning(f"–û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ {message_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ.")
#                 # –£–¥–∞–ª—è–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ
#                 context.user_data.pop('main_menu_message_id', None)
#                 context.user_data.pop('main_menu_chat_id', None)
#                 message_id = None # –°–±—Ä–æ—Å–∏–º message_id, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
#             else:
#                 logger.error(f"–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è {message_id}: {e}")
#                 # –î–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ message_id –±—ã–ª
#                 return
#
#     # –ï—Å–ª–∏ message_id –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
#     # –≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –∏–ª–∏ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
#     try:
#         sent_message = await context.bot.send_message(
#             chat_id=chat_id,
#             text=status_text,
#             reply_markup=menu_markup,
#             parse_mode='Markdown'
#         )
#         # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
#         context.user_data['main_menu_message_id'] = sent_message.message_id
#         context.user_data['main_menu_chat_id'] = sent_message.chat_id
#         logger.info(f"–ù–æ–≤–æ–µ –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ {sent_message.message_id} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç {sent_message.chat_id}.")
#     except Exception as e:
#         logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤–æ–≥–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")


# # --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ ---
# async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
#     user_id = update.effective_user.id
#     is_admin = (user_id == ADMIN_TELEGRAM_ID)
#     # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è
#     bot_user_id, timestamp = get_session(user_id)
#     is_logged_in = bot_user_id is not None and (time.time() - timestamp) < SESSION_TIMEOUT
#     if is_logged_in:
#         welcome_text = "üëã *–ü—Ä–∏–≤–µ—Ç!* –í—ã —É–∂–µ –≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É."
#     else:
#         welcome_text = "üëã *–ü—Ä–∏–≤–µ—Ç!* –Ø –±–æ—Ç –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏."
#
#     # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ /start
#     try:
#         await context.bot.delete_message(chat_id=update.effective_chat.id, message_id=update.effective_message.message_id)
#         logger.debug(f"–°–æ–æ–±—â–µ–Ω–∏–µ /start –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É–¥–∞–ª–µ–Ω–æ.")
#     except Exception as e:
#         logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ /start {update.effective_message.message_id}: {e}")
#
#     # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
#     await update_main_message(update, context, welcome_text, is_logged_in)

# async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
#     """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏"""
#     query = update.callback_query
#     await query.answer()
#     user_id = query.from_user.id
#     data = query.data
#     is_admin = (user_id == ADMIN_TELEGRAM_ID)
#     # –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç—ë–∫—à–∏—Ö —Å–µ—Å—Å–∏–π
#     cleanup_expired_sessions()
#
#     # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
#     bot_user_id, timestamp = get_session(user_id)
#     is_logged_in = bot_user_id is not None and (time.time() - timestamp) < SESSION_TIMEOUT
#
#     if data == 'register':
#         status_text = (
#             "üìù *–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è*\n\n"
#             "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
#             "`/register <–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π_–ª–æ–≥–∏–Ω> <–ø–∞—Ä–æ–ª—å>`\n\n"
#             "*–í–∞–∂–Ω–æ:* –≠—Ç–æ—Ç –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—Ö–æ–¥–∞ –≤ *—ç—Ç–æ—Ç –±–æ—Ç* –∏ –Ω–µ —Å–≤—è–∑–∞–Ω —Å –≤–∞—à–µ–π —É—á–µ—Ç–∫–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ."
#         )
#         await update_main_message(update, context, status_text, is_logged_in=False) # –ü–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–æ—á–Ω–æ –Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω
#
#     elif data == 'login':
#         # –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω (–ø–æ —Å–µ—Å—Å–∏–∏)
#         if is_logged_in:
#              # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–∞—É—Ç
#              create_session(user_id, bot_user_id)
#              status_text = "‚úÖ –í—ã —É–∂–µ –≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É."
#              await update_main_message(update, context, status_text, is_logged_in=True)
#         else:
#             status_text = (
#                 "üîë *–í—Ö–æ–¥*\n\n"
#                 "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
#                 "`/login <–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π_–ª–æ–≥–∏–Ω> <–ø–∞—Ä–æ–ª—å>`"
#             )
#             await update_main_message(update, context, status_text, is_logged_in=False)
#
#     elif data == 'restart':
#         if not is_logged_in:
#             status_text = "‚ùå –°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å."
#             await update_main_message(update, context, status_text, is_logged_in=False)
#             return
#         # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–∞—É—Ç
#         create_session(user_id, bot_user_id)
#         status_text = (
#             "üîÑ *–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Å—Å–∏–∏*\n\n"
#             "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Å—Å–∏–∏:\n"
#             "`/restart <–∏–º—è_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è_–Ω–∞_—Å–µ—Ä–≤–µ—Ä–µ>`"
#         )
#         await update_main_message(update, context, status_text, is_logged_in=True)
#
#     elif data == 'logout':
#         delete_session(user_id)
#         status_text = "‚úÖ –í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã."
#         await update_main_message(update, context, status_text, is_logged_in=False) # –ù–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω
#
#     elif data == 'settings':
#         if not is_admin:
#             await query.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º.", show_alert=True)
#             # –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
#             # await update_main_message(update, context, "‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω.", is_logged_in=is_logged_in)
#             return
#         # –ü–µ—Ä–µ—Ö–æ–¥ –≤ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫
#         settings_text = f"‚öôÔ∏è *–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞*\n\n–¢–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:"
#         # –ü–æ–ª—É—á–∞–µ–º chat_id –∏ message_id –∏–∑ context.user_data –∏–ª–∏ update
#         chat_id = context.user_data.get('main_menu_chat_id') or update.effective_chat.id
#         message_id = context.user_data.get('main_menu_message_id') or query.message.message_id
#
#         try:
#             await context.bot.edit_message_text(
#                 chat_id=chat_id,
#                 message_id=message_id,
#                 text=settings_text,
#                 parse_mode='Markdown',
#                 reply_markup=get_settings_menu()
#             )
#         except Exception as e:
#              logger.error(f"–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: {e}")
#              # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
#              try:
#                  sent_message = await context.bot.send_message(
#                      chat_id=chat_id,
#                      text=settings_text,
#                      reply_markup=get_settings_menu(),
#                      parse_mode='Markdown'
#                  )
#                  context.user_data['main_menu_message_id'] = sent_message.message_id
#                  context.user_data['main_menu_chat_id'] = sent_message.chat_id
#              except Exception as e2:
#                  logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫: {e2}")

# async def settings_button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
#     """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏ –≤–Ω—É—Ç—Ä–∏ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
#     query = update.callback_query
#     await query.answer()
#     user_id = query.from_user.id
#
#     if user_id != ADMIN_TELEGRAM_ID:
#         await query.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤.", show_alert=True)
#         return
#
#     data = query.data
#
#     if data == 'change_timeout':
#         # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤–≤–µ—Å—Ç–∏ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
#         instruction_text = (
#             f"‚è±Ô∏è *–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∞–π–º–∞—É—Ç–∞ —Å–µ—Å—Å–∏–∏*\n\n"
#             f"–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: `{SESSION_TIMEOUT}` —Å–µ–∫—É–Ω–¥.\n"
#             f"–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö –∫–æ–º–∞–Ω–¥–æ–π:\n"
#             f"`/set_timeout <–∑–Ω–∞—á–µ–Ω–∏–µ>`"
#         )
#         # –ü–æ–ª—É—á–∞–µ–º chat_id –∏ message_id –∏–∑ context.user_data –∏–ª–∏ update
#         chat_id = context.user_data.get('main_menu_chat_id') or update.effective_chat.id
#         message_id = context.user_data.get('main_menu_message_id') or query.message.message_id
#
#         try:
#             await context.bot.edit_message_text(
#                 chat_id=chat_id,
#                 message_id=message_id,
#                 text=instruction_text,
#                 parse_mode='Markdown',
#                 reply_markup=get_settings_menu() # –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –º–µ–Ω—é, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –≤–µ—Ä–Ω—É—Ç—å—Å—è
#             )
#         except Exception as e:
#              logger.error(f"–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∞–π–º–∞—É—Ç–∞: {e}")
#              # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
#              try:
#                  sent_message = await context.bot.send_message(
#                      chat_id=chat_id,
#                      text=instruction_text,
#                      reply_markup=get_settings_menu(),
#                      parse_mode='Markdown'
#                  )
#                  context.user_data['main_menu_message_id'] = sent_message.message_id
#                  context.user_data['main_menu_chat_id'] = sent_message.chat_id
#              except Exception as e2:
#                  logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∞–π–º–∞—É—Ç–∞: {e2}")
#
#     elif data == 'back_to_main':
#         # –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
#         # –ù—É–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∞–¥–º–∏–Ω–∞ –∏ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω–æ—Å—Ç–∏
#         bot_user_id, timestamp = get_session(user_id)
#         is_logged_in = bot_user_id is not None and (time.time() - timestamp) < SESSION_TIMEOUT
#         is_admin = (user_id == ADMIN_TELEGRAM_ID)
#         main_text = "‚¨ÖÔ∏è *–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é*"
#         if is_logged_in:
#             main_text += "\n\n‚úÖ –í—ã –≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É."
#         # –ü–æ–ª—É—á–∞–µ–º chat_id –∏ message_id –∏–∑ context.user_data –∏–ª–∏ update
#         chat_id = context.user_data.get('main_menu_chat_id') or update.effective_chat.id
#         message_id = context.user_data.get('main_menu_message_id') or query.message.message_id
#
#         try:
#             await context.bot.edit_message_text(
#                 chat_id=chat_id,
#                 message_id=message_id,
#                 text=main_text,
#                 parse_mode='Markdown',
#                 reply_markup=get_main_menu(is_logged_in, is_admin)
#             )
#         except Exception as e:
#              logger.error(f"–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é: {e}")
#              # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
#              try:
#                  sent_message = await context.bot.send_message(
#                      chat_id=chat_id,
#                      text=main_text,
#                      reply_markup=get_main_menu(is_logged_in, is_admin),
#                      parse_mode='Markdown'
#                  )
#                  context.user_data['main_menu_message_id'] = sent_message.message_id
#                  context.user_data['main_menu_chat_id'] = sent_message.chat_id
#              except Exception as e2:
#                  logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é: {e2}")
#
#     elif data == 'dummy_info':
#         # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç
#         await query.answer("–≠—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ –ø–æ–ª–µ.", show_alert=False)

# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ ---
# async def set_timeout(update: Update, context: ContextTypes.DEFAULT_TYPE):
#     """–ö–æ–º–∞–Ω–¥–∞ /set_timeout <–∑–Ω–∞—á–µ–Ω–∏–µ> –¥–ª—è –∞–¥–º–∏–Ω–∞"""
#     user_id = update.effective_user.id
#     chat_id = update.effective_chat.id
#     message_id = update.effective_message.message_id
#     global SESSION_TIMEOUT
#
#     if user_id != ADMIN_TELEGRAM_ID:
#         response_text = "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫."
#         # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∞–¥–º–∏–Ω—É –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
#         bot_user_id, timestamp = get_session(user_id)
#         is_logged_in = bot_user_id is not None and (time.time() - timestamp) < SESSION_TIMEOUT
#         is_admin_user = (user_id == ADMIN_TELEGRAM_ID)
#         await update_main_message(update, context, response_text, is_logged_in)
#         try:
#              await context.bot.delete_message(chat_id=chat_id, message_id=message_id)
#              logger.debug(f"–°–æ–æ–±—â–µ–Ω–∏–µ /set_timeout –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É–¥–∞–ª–µ–Ω–æ.")
#         except Exception as e:
#              logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ /set_timeout {message_id}: {e}")
#         return
#
#     if not context.args or not context.args[0].isdigit():
#         response_text = "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: `/set_timeout <–∑–Ω–∞—á–µ–Ω–∏–µ_–≤_—Å–µ–∫—É–Ω–¥–∞—Ö>`"
#         # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∞–¥–º–∏–Ω—É –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
#         bot_user_id, timestamp = get_session(user_id)
#         is_logged_in = bot_user_id is not None and (time.time() - timestamp) < SESSION_TIMEOUT
#         is_admin_user = (user_id == ADMIN_TELEGRAM_ID)
#         await update_main_message(update, context, response_text, is_logged_in)
#         try:
#              await context.bot.delete_message(chat_id=chat_id, message_id=message_id)
#              logger.debug(f"–°–æ–æ–±—â–µ–Ω–∏–µ /set_timeout –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É–¥–∞–ª–µ–Ω–æ.")
#         except Exception as e:
#              logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ /set_timeout {message_id}: {e}")
#         return
#
#
#     new_timeout = int(context.args[0])
#     if new_timeout <= 0:
#         response_text = "‚ùå –ó–Ω–∞—á–µ–Ω–∏–µ —Ç–∞–π–º–∞—É—Ç–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º."
#         # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∞–¥–º–∏–Ω—É –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
#         bot_user_id, timestamp = get_session(user_id)
#         is_logged_in = bot_user_id is not None and (time.time() - timestamp) < SESSION_TIMEOUT
#         is_admin_user = (user_id == ADMIN_TELEGRAM_ID)
#         await update_main_message(update, context, response_text, is_logged_in)
#         try:
#              await context.bot.delete_message(chat_id=chat_id, message_id=message_id)
#              logger.debug(f"–°–æ–æ–±—â–µ–Ω–∏–µ /set_timeout –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É–¥–∞–ª–µ–Ω–æ.")
#         except Exception as e:
#              logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ /set_timeout {message_id}: {e}")
#         return
#
#     old_timeout = SESSION_TIMEOUT
#     SESSION_TIMEOUT = new_timeout
#
#     response_text = f"‚úÖ –¢–∞–π–º–∞—É—Ç —Å–µ—Å—Å–∏–∏ –∏–∑–º–µ–Ω—ë–Ω —Å {old_timeout} —Å–µ–∫ –Ω–∞ {new_timeout} —Å–µ–∫."
#
#     # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–º–∞–Ω–¥–æ–π
#     try:
#         await context.bot.delete_message(chat_id=chat_id, message_id=message_id)
#         logger.info(f"–°–æ–æ–±—â–µ–Ω–∏–µ /set_timeout –æ—Ç –∞–¥–º–∏–Ω–∞ {user_id} —É–¥–∞–ª–µ–Ω–æ.")
#     except Exception as e:
#         logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ /set_timeout {message_id}: {e}")
#
#     # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫
#     # –ü–æ–ª—É—á–∞–µ–º chat_id –∏ message_id –∏–∑ context.user_data –∏–ª–∏ update
#     main_chat_id = context.user_data.get('main_menu_chat_id') or chat_id
#     main_message_id = context.user_data.get('main_menu_message_id')
#
#     if main_message_id:
#         try:
#             await context.bot.edit_message_text(
#                 chat_id=main_chat_id,
#                 message_id=main_message_id,
#                 text=response_text + "\n\n–í–æ–∑–≤—Ä–∞—â–∞—é—Å—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...",
#                 parse_mode='Markdown'
#             )
#             # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –≤–æ–∑–≤—Ä–∞—Ç–æ–º –≤ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫
#             await asyncio.sleep(1.5)
#             await context.bot.edit_message_text(
#                 chat_id=main_chat_id,
#                 message_id=main_message_id,
#                 text="‚öôÔ∏è *–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞*\n\n–¢–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:",
#                 parse_mode='Markdown',
#                 reply_markup=get_settings_menu()
#             )
#         except Exception as e:
#              logger.error(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ set_timeout: {e}")
#              # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
#              try:
#                  sent_message = await context.bot.send_message(
#                      chat_id=main_chat_id,
#                      text="‚öôÔ∏è *–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞*\n\n–¢–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:",
#                      reply_markup=get_settings_menu(),
#                      parse_mode='Markdown'
#                  )
#                  context.user_data['main_menu_message_id'] = sent_message.message_id
#                  context.user_data['main_menu_chat_id'] = sent_message.chat_id
#              except Exception as e2:
#                  logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ—Å–ª–µ set_timeout: {e2}")
#     else:
#         # –ï—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
#         try:
#              sent_message = await context.bot.send_message(
#                  chat_id=main_chat_id,
#                  text="‚öôÔ∏è *–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞*\n\n–¢–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:",
#                  reply_markup=get_settings_menu(),
#                  parse_mode='Markdown'
#              )
#              context.user_data['main_menu_message_id'] = sent_message.message_id
#              context.user_data['main_menu_chat_id'] = sent_message.chat_id
#         except Exception as e:
#              logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ—Å–ª–µ set_timeout (–Ω–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ): {e}")

# --- –û—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ ---
# async def register(update: Update, context: ContextTypes.DEFAULT_TYPE):
#     user_id = update.effective_user.id
#     chat_id = update.effective_chat.id
#     message_id = update.effective_message.message_id
#
#     # –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
#     with get_db_connection() as conn:
#         cursor = conn.cursor()
#         cursor.execute("SELECT status FROM bot_users WHERE telegram_id = ?", (user_id,))
#         existing_user = cursor.fetchone()
#
#     if existing_user:
#         status = existing_user[0]
#         if status == 'active':
#             status_text = "‚úÖ –í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏ –æ–¥–æ–±—Ä–µ–Ω—ã."
#         elif status == 'pending':
#             status_text = "‚è≥ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –æ–∂–∏–¥–∞–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞."
#         else: # banned
#              status_text = "‚ÑπÔ∏è –í–∞—à–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞."
#         # –£–¥–∞–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
#         try:
#              await context.bot.delete_message(chat_id=chat_id, message_id=message_id)
#              logger.debug(f"–°–æ–æ–±—â–µ–Ω–∏–µ /register –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É–¥–∞–ª–µ–Ω–æ.")
#         except Exception as e:
#              logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ /register {message_id}: {e}")
#         await update_main_message(update, context, status_text, is_logged_in=False) # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ–Ω –Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω
#         return
#
#     if len(context.args) < 2:
#         status_text = (
#             "üìù *–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è*\n\n"
#             "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: `/register <–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π_–ª–æ–≥–∏–Ω> <–ø–∞—Ä–æ–ª—å>`\n\n"
#             "*–í–∞–∂–Ω–æ:* –≠—Ç–æ—Ç –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—Ö–æ–¥–∞ –≤ *—ç—Ç–æ—Ç –±–æ—Ç* –∏ –Ω–µ —Å–≤—è–∑–∞–Ω —Å –≤–∞—à–µ–π —É—á–µ—Ç–∫–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ."
#         )
#         # –£–¥–∞–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
#         try:
#              await context.bot.delete_message(chat_id=chat_id, message_id=message_id)
#              logger.debug(f"–°–æ–æ–±—â–µ–Ω–∏–µ /register –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É–¥–∞–ª–µ–Ω–æ.")
#         except Exception as e:
#              logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ /register {message_id}: {e}")
#         await update_main_message(update, context, status_text, is_logged_in=False)
#         return
#
#     username = context.args[0].strip()
#     password = context.args[1]
#
#     if register_bot_user(user_id, username, password):
#         status_text = "‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ. –û–∂–∏–¥–∞–π—Ç–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞."
#         # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞ (–æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º, –∫–∞–∫ –∏ –±—ã–ª–æ)
#         approve_button = InlineKeyboardButton("‚úÖ –û–¥–æ–±—Ä–∏—Ç—å", callback_data=f'approve_{user_id}')
#         keyboard = [[approve_button]]
#         reply_markup = InlineKeyboardMarkup(keyboard)
#         try:
#             await context.bot.send_message(
#                 chat_id=ADMIN_TELEGRAM_ID,
#                 text=f"üîî –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é!\nTelegram User ID: `{user_id}`\n–ò–º—è: {update.effective_user.full_name or 'N/A'}\nUsername: @{update.effective_user.username or 'N/A'}\n–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ª–æ–≥–∏–Ω: `{username}`",
#                 parse_mode='Markdown',
#                 reply_markup=reply_markup
#             )
#         except Exception as e:
#              logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: {e}")
#         logger.info(f"–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} (–≤–Ω—É—Ç—Ä. –ª–æ–≥–∏–Ω: {username})")
#     else:
#         status_text = "‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –í–æ–∑–º–æ–∂–Ω–æ, –ª–æ–≥–∏–Ω —É–∂–µ –∑–∞–Ω—è—Ç."
#
#     # –£–¥–∞–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
#     try:
#         await context.bot.delete_message(chat_id=chat_id, message_id=message_id)
#         logger.debug(f"–°–æ–æ–±—â–µ–Ω–∏–µ /register –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É–¥–∞–ª–µ–Ω–æ.")
#     except Exception as e:
#         logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ /register {message_id}: {e}")
#
#     await update_main_message(update, context, status_text, is_logged_in=False)

# async def approve_user_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
#     """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /approve <user_id> –æ—Ç –∞–¥–º–∏–Ω–∞."""
#     user_id = update.effective_user.id
#     chat_id = update.effective_chat.id
#     message_id = update.effective_message.message_id
#
#     if user_id != ADMIN_TELEGRAM_ID:
#         status_text = "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –æ–¥–æ–±—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."
#         # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∞–¥–º–∏–Ω—É –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
#         bot_user_id, timestamp = get_session(user_id)
#         is_logged_in = bot_user_id is not None and (time.time() - timestamp) < SESSION_TIMEOUT
#         is_admin_user = (user_id == ADMIN_TELEGRAM_ID)
#         await update_main_message(update, context, status_text, is_logged_in)
#         try:
#              await context.bot.delete_message(chat_id=chat_id, message_id=message_id)
#              logger.debug(f"–°–æ–æ–±—â–µ–Ω–∏–µ /approve –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É–¥–∞–ª–µ–Ω–æ.")
#         except Exception as e:
#              logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ /approve {message_id}: {e}")
#         return
#
#     if not context.args or not context.args[0].isdigit():
#         status_text = "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: `/approve <telegram_user_id>`"
#         # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∞–¥–º–∏–Ω—É –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
#         bot_user_id, timestamp = get_session(user_id)
#         is_logged_in = bot_user_id is not None and (time.time() - timestamp) < SESSION_TIMEOUT
#         is_admin_user = (user_id == ADMIN_TELEGRAM_ID)
#         await update_main_message(update, context, status_text, is_logged_in)
#         try:
#              await context.bot.delete_message(chat_id=chat_id, message_id=message_id)
#              logger.debug(f"–°–æ–æ–±—â–µ–Ω–∏–µ /approve –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É–¥–∞–ª–µ–Ω–æ.")
#         except Exception as e:
#              logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ /approve {message_id}: {e}")
#         return
#
#     target_telegram_id = int(context.args[0])
#     with get_db_connection() as conn:
#         cursor = conn.cursor()
#         cursor.execute("SELECT status FROM bot_users WHERE telegram_id = ?", (target_telegram_id,))
#         row = cursor.fetchone()
#
#     if not row:
#         status_text = f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å Telegram ID {target_telegram_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∑–∞—è–≤–∫–∞—Ö."
#         # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∞–¥–º–∏–Ω—É –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
#         bot_user_id, timestamp = get_session(user_id)
#         is_logged_in = bot_user_id is not None and (time.time() - timestamp) < SESSION_TIMEOUT
#         is_admin_user = (user_id == ADMIN_TELEGRAM_ID)
#         await update_main_message(update, context, status_text, is_logged_in)
#         try:
#              await context.bot.delete_message(chat_id=chat_id, message_id=message_id)
#              logger.debug(f"–°–æ–æ–±—â–µ–Ω–∏–µ /approve –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É–¥–∞–ª–µ–Ω–æ.")
#         except Exception as e:
#              logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ /approve {message_id}: {e}")
#         return
#
#     current_status = row[0]
#     if current_status == 'active':
#         status_text = f"‚ÑπÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {target_telegram_id} —É–∂–µ –æ–¥–æ–±—Ä–µ–Ω."
#     elif current_status in ['pending', 'banned']:
#         approve_user(target_telegram_id)
#         status_text = f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {target_telegram_id} –æ–¥–æ–±—Ä–µ–Ω."
#         try:
#             # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–± –æ–¥–æ–±—Ä–µ–Ω–∏–∏ (–æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º)
#             await context.bot.send_message(
#                 chat_id=target_telegram_id,
#                 text="üéâ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –≤ –±–æ—Ç–∞.",
#                 reply_markup=get_main_menu(is_logged_in=False) # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω
#             )
#         except Exception as e:
#             logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {target_telegram_id} –æ–± –æ–¥–æ–±—Ä–µ–Ω–∏–∏: {e}")
#     else:
#         status_text = f"‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–¥–æ–±—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º {current_status}."
#
#     # –£–¥–∞–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
#     try:
#         await context.bot.delete_message(chat_id=chat_id, message_id=message_id)
#         logger.debug(f"–°–æ–æ–±—â–µ–Ω–∏–µ /approve –æ—Ç –∞–¥–º–∏–Ω–∞ {user_id} —É–¥–∞–ª–µ–Ω–æ.")
#     except Exception as e:
#         logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ /approve {message_id}: {e}")
#
#     # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∞–¥–º–∏–Ω—É –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
#     bot_user_id, timestamp = get_session(user_id)
#     is_logged_in_admin = bot_user_id is not None and (time.time() - timestamp) < SESSION_TIMEOUT
#     is_admin_user = (user_id == ADMIN_TELEGRAM_ID)
#     await update_main_message(update, context, status_text, is_logged_in_admin)

# async def button_approve_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
#     """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ '–û–¥–æ–±—Ä–∏—Ç—å' –∞–¥–º–∏–Ω–æ–º."""
#     query = update.callback_query
#     await query.answer()
#     admin_id = query.from_user.id
#
#     if admin_id != ADMIN_TELEGRAM_ID:
#         await query.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –æ–¥–æ–±—Ä–µ–Ω–∏—è.", show_alert=True)
#         return
#
#     data = query.data
#     if data.startswith('approve_'):
#         target_telegram_id = int(data.split('_')[1])
#         with get_db_connection() as conn:
#             cursor = conn.cursor()
#             cursor.execute("SELECT status FROM bot_users WHERE telegram_id = ?", (target_telegram_id,))
#             row = cursor.fetchone()
#
#         if not row:
#              status_text = f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {target_telegram_id} –Ω–µ –Ω–∞–π–¥–µ–Ω."
#              # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞
#              is_admin_logged_in = get_session(admin_id)[0] is not None and (time.time() - get_session(admin_id)[1]) < SESSION_TIMEOUT
#              menu_markup = get_main_menu(is_logged_in=is_admin_logged_in, is_admin=True)
#              await query.edit_message_text(text=status_text, reply_markup=menu_markup)
#              return
#
#         current_status = row[0]
#         if current_status == 'active':
#             status_text = f"‚ÑπÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {target_telegram_id} —É–∂–µ –æ–¥–æ–±—Ä–µ–Ω."
#         elif current_status in ['pending', 'banned']:
#             approve_user(target_telegram_id)
#             status_text = f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {target_telegram_id} –æ–¥–æ–±—Ä–µ–Ω —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É."
#             try:
#                 # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–± –æ–¥–æ–±—Ä–µ–Ω–∏–∏ (–æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º)
#                 await context.bot.send_message(
#                     chat_id=target_telegram_id,
#                     text="üéâ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –≤ –±–æ—Ç–∞.",
#                     reply_markup=get_main_menu(is_logged_in=False) # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω
#                 )
#             except Exception as e:
#                  logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {target_telegram_id} –æ–± –æ–¥–æ–±—Ä–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É: {e}")
#         else:
#              status_text = f"‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–¥–æ–±—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º {current_status}."
#
#         # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞
#         is_admin_logged_in = get_session(admin_id)[0] is not None and (time.time() - get_session(admin_id)[1]) < SESSION_TIMEOUT
#         menu_markup = get_main_menu(is_logged_in=is_admin_logged_in, is_admin=True)
#         await query.edit_message_text(text=status_text, reply_markup=menu_markup)

# async def login(update: Update, context: ContextTypes.DEFAULT_TYPE):
#     user_id = update.effective_user.id
#     chat_id = update.effective_chat.id
#     message_id = update.effective_message.message_id
#     # –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç—ë–∫—à–∏—Ö —Å–µ—Å—Å–∏–π
#     cleanup_expired_sessions()
#
#     # –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω (–ø–æ —Å–µ—Å—Å–∏–∏)
#     bot_user_id, timestamp = get_session(user_id)
#     is_logged_in = bot_user_id is not None and (time.time() - timestamp) < SESSION_TIMEOUT
#     if is_logged_in:
#         # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–∞—É—Ç
#         create_session(user_id, bot_user_id)
#         status_text = "‚úÖ –í—ã —É–∂–µ –≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É."
#         # –£–¥–∞–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
#         try:
#              await context.bot.delete_message(chat_id=chat_id, message_id=message_id)
#              logger.debug(f"–°–æ–æ–±—â–µ–Ω–∏–µ /login –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É–¥–∞–ª–µ–Ω–æ.")
#         except Exception as e:
#              logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ /login {message_id}: {e}")
#         await update_main_message(update, context, status_text, is_logged_in=True)
#         return
#
#     if len(context.args) < 2:
#         status_text = (
#             "üîë *–í—Ö–æ–¥*\n\n"
#             "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: `/login <–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π_–ª–æ–≥–∏–Ω> <–ø–∞—Ä–æ–ª—å>`"
#         )
#         # –£–¥–∞–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
#         try:
#              await context.bot.delete_message(chat_id=chat_id, message_id=message_id)
#              logger.debug(f"–°–æ–æ–±—â–µ–Ω–∏–µ /login –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É–¥–∞–ª–µ–Ω–æ.")
#         except Exception as e:
#              logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ /login {message_id}: {e}")
#         await update_main_message(update, context, status_text, is_logged_in=False)
#         return
#
#     username = context.args[0].strip()
#     password = context.args[1]
#     # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—á—ë—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
#     authenticated_telegram_id, authenticated_bot_user_id = authenticate_user(username, password)
#     if authenticated_telegram_id is not None and authenticated_telegram_id == user_id:
#         # –£—Å–ø–µ—à–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ Telegram ID
#         create_session(user_id, authenticated_bot_user_id) # –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Å—Å–∏—é
#         status_text = f"‚úÖ –í—ã –≤–æ—à–ª–∏ –∫–∞–∫ `{username}`."
#         is_logged_in = True
#         logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —É—Å–ø–µ—à–Ω–æ –≤–æ—à—ë–ª –∫–∞–∫ {username}")
#     elif authenticated_telegram_id is not None and authenticated_telegram_id != user_id:
#         # –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å, –Ω–æ –¥—Ä—É–≥–æ–π Telegram ID
#         status_text = "‚ùå –≠—Ç–∞ —É—á–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –¥—Ä—É–≥–æ–º—É –∞–∫–∫–∞—É–Ω—Ç—É Telegram."
#         is_logged_in = False
#         logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞ –ø–æ–¥ —á—É–∂–æ–π —É—á–µ—Ç–∫–æ–π: Telegram ID {user_id} –ø—ã—Ç–∞–ª—Å—è –≤–æ–π—Ç–∏ –∫–∞–∫ {username} (–≤–ª–∞–¥–µ–ª–µ—Ü: {authenticated_telegram_id})")
#     else:
#         # –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å
#         status_text = "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å."
#         is_logged_in = False
#         logger.warning(f"–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —Å –ª–æ–≥–∏–Ω–æ–º {username}")
#
#     # –£–¥–∞–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
#     try:
#         await context.bot.delete_message(chat_id=chat_id, message_id=message_id)
#         logger.debug(f"–°–æ–æ–±—â–µ–Ω–∏–µ /login –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É–¥–∞–ª–µ–Ω–æ.")
#     except Exception as e:
#         logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ /login {message_id}: {e}")
#
#     await update_main_message(update, context, status_text, is_logged_in)

# async def restart(update: Update, context: ContextTypes.DEFAULT_TYPE):
#      user_id = update.effective_user.id
#      chat_id = update.effective_chat.id
#      message_id = update.effective_message.message_id
#      # –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç—ë–∫—à–∏—Ö —Å–µ—Å—Å–∏–π
#      cleanup_expired_sessions()
#
#      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏
#      bot_user_id, timestamp = get_session(user_id)
#      is_logged_in = bot_user_id is not None and (time.time() - timestamp) < SESSION_TIMEOUT
#      if not is_logged_in:
#          status_text = "‚ùå –°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å."
#          # –£–¥–∞–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
#          try:
#               await context.bot.delete_message(chat_id=chat_id, message_id=message_id)
#               logger.debug(f"–°–æ–æ–±—â–µ–Ω–∏–µ /restart –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É–¥–∞–ª–µ–Ω–æ.")
#          except Exception as e:
#               logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ /restart {message_id}: {e}")
#          await update_main_message(update, context, status_text, is_logged_in=False)
#          return
#
#      # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–∞—É—Ç —Å–µ—Å—Å–∏–∏
#      create_session(user_id, bot_user_id)
#
#      if not context.args:
#          status_text = (
#              "üîÑ *–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Å—Å–∏–∏*\n\n"
#              "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:\n"
#              "`/restart <–∏–º—è_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è_–Ω–∞_—Å–µ—Ä–≤–µ—Ä–µ>`"
#          )
#          # –£–¥–∞–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
#          try:
#               await context.bot.delete_message(chat_id=chat_id, message_id=message_id)
#               logger.debug(f"–°–æ–æ–±—â–µ–Ω–∏–µ /restart –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É–¥–∞–ª–µ–Ω–æ.")
#          except Exception as e:
#               logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ /restart {message_id}: {e}")
#          await update_main_message(update, context, status_text, is_logged_in=True)
#          return
#
#      target_username = context.args[0].strip()
#
#      # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Å—Ç–∞—Ç—É—Å "–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è" –∫–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
#      # –≠—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –Ω–µ –æ—Å–Ω–æ–≤–Ω–æ–µ.
#      try:
#          status_message = await update.message.reply_text(f"üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é —Å–µ—Å—Å–∏—é –¥–ª—è '{target_username}' –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ...")
#      except Exception as e:
#          logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: {e}")
#          status_message = None
#
#      # –í—ã–ø–æ–ª–Ω—è–µ–º SSH –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
#      loop = asyncio.get_event_loop()
#      result = await loop.run_in_executor(
#          None,
#          lambda username: asyncio.run(restart_user_session_on_server(username)),
#          target_username
#      )
#
#      # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
#      if status_message:
#          try:
#              # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
#              await status_message.edit_text(result)
#              # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
#              # await asyncio.sleep(5)
#              # await context.bot.delete_message(chat_id=status_message.chat_id, message_id=status_message.message_id)
#          except Exception as e:
#               logger.error(f"–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: {e}")
#
#      # –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –∏–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ
#      # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ö–æ—á–µ—Ç —Å–¥–µ–ª–∞—Ç—å –µ—â–µ —á—Ç–æ-—Ç–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é.
#      await update_main_message(update, context, result + "\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–µ–¥—É—é—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ:", is_logged_in=True)
#
#      # –£–¥–∞–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∫–æ–º–∞–Ω–¥–æ–π
#      try:
#           await context.bot.delete_message(chat_id=chat_id, message_id=message_id)
#           logger.info(f"–°–æ–æ–±—â–µ–Ω–∏–µ /restart –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É–¥–∞–ª–µ–Ω–æ.")
#      except Exception as e:
#           logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ /restart {message_id}: {e}")

# async def logout(update: Update, context: ContextTypes.DEFAULT_TYPE):
#     user_id = update.effective_user.id
#     chat_id = update.effective_chat.id
#     message_id = update.effective_message.message_id
#     delete_session(user_id) # –£–¥–∞–ª—è–µ–º —Å–µ—Å—Å–∏—é
#     status_text = "‚úÖ –í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã."
#     # –£–¥–∞–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
#     try:
#         await context.bot.delete_message(chat_id=chat_id, message_id=message_id)
#         logger.debug(f"–°–æ–æ–±—â–µ–Ω–∏–µ /logout –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É–¥–∞–ª–µ–Ω–æ.")
#     except Exception as e:
#         logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ /logout {message_id}: {e}")
#     await update_main_message(update, context, status_text, is_logged_in=False)